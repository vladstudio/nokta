#cloud-config
#
# Nokta - One-click server deployment
#
# INSTRUCTIONS:
# 1. Edit the 5 variables below
# 2. Point your domain's DNS to your server IP
# 3. Create Ubuntu 24.04 server on Hetzner/DigitalOcean/Vultr
# 4. Paste this entire file into "User Data / Cloud Init / Cloud Config"
# 5. Wait ~5 minutes, then visit https://your-domain.com
#

runcmd:
  - |
    set -e
    exec > /var/log/nokta-install.log 2>&1

    # ==============================================================
    # USER CONFIG - EDIT THESE LINES
    # ==============================================================
    DOMAIN="nokta.example.com"
    ADMIN_EMAIL="you@example.com"
    ADMIN_PASSWORD="change-this-password"
    DAILY_API_KEY="your-daily-co-api-key"
    SSH_KEY="ssh-rsa AAAAB3... your-public-key"
    # Optional: Firebase for Android push notifications
    # Get JSON from: Firebase Console → Project Settings → Service accounts → Generate new private key
    # Encode with: cat firebase-service-account.json | base64 | tr -d '\n'
    FIREBASE_SA_BASE64=""
    # Required if using Firebase. Generate with: openssl rand -hex 32
    FCM_API_KEY=""
    # ==============================================================

    APP_USER="nokta"
    APP_DIR="/home/$APP_USER/nokta"
    PB_VERSION="0.23.6"

    echo "=== Nokta Installation Started ==="

    # --- System Setup ---
    apt-get update
    DEBIAN_FRONTEND=noninteractive apt-get upgrade -y
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
      curl wget git unzip ufw fail2ban logrotate \
      debian-keyring debian-archive-keyring apt-transport-https

    # --- Create User ---
    useradd -m -s /bin/bash "$APP_USER"
    echo "$APP_USER:$ADMIN_PASSWORD" | chpasswd
    usermod -aG sudo "$APP_USER"
    mkdir -p /home/$APP_USER/.ssh
    echo "$SSH_KEY" > /home/$APP_USER/.ssh/authorized_keys
    chmod 700 /home/$APP_USER/.ssh
    chmod 600 /home/$APP_USER/.ssh/authorized_keys
    chown -R $APP_USER:$APP_USER /home/$APP_USER/.ssh

    # --- Harden SSH ---
    cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup
    cat > /etc/ssh/sshd_config << EOF
    UsePAM yes
    PermitRootLogin no
    MaxAuthTries 3
    LoginGraceTime 20
    PasswordAuthentication no
    PermitEmptyPasswords no
    ChallengeResponseAuthentication no
    X11Forwarding no
    AllowUsers $APP_USER
    AcceptEnv LANG LC_*
    Subsystem sftp /usr/lib/openssh/sftp-server
    EOF
    systemctl restart ssh

    # --- Firewall ---
    ufw --force reset
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow 22/tcp
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw --force enable

    # --- Fail2ban ---
    cat > /etc/fail2ban/jail.local << EOF
    [DEFAULT]
    bantime = 3600
    findtime = 600
    maxretry = 3

    [sshd]
    enabled = true
    EOF
    systemctl enable fail2ban
    systemctl restart fail2ban

    # --- System Hardening ---
    cat >> /etc/sysctl.conf << EOF

    # Security hardening
    net.ipv4.conf.all.accept_redirects = 0
    net.ipv6.conf.all.accept_redirects = 0
    net.ipv4.conf.all.send_redirects = 0
    net.ipv4.conf.all.accept_source_route = 0
    net.ipv6.conf.all.accept_source_route = 0
    net.ipv4.icmp_echo_ignore_broadcasts = 1
    net.ipv4.tcp_syncookies = 1
    EOF
    sysctl -p > /dev/null 2>&1
    timedatectl set-timezone UTC

    # --- Install Caddy ---
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
    apt-get update
    apt-get install -y caddy

    # --- Install bun ---
    sudo -u $APP_USER bash -c 'curl -fsSL https://bun.sh/install | bash'

    # --- Download Nokta ---
    curl -L https://github.com/vladstudio/nokta/archive/refs/heads/main.tar.gz | tar -xz -C /home/$APP_USER
    mv /home/$APP_USER/nokta-main $APP_DIR
    chown -R $APP_USER:$APP_USER $APP_DIR

    # --- Download PocketBase ---
    ARCH=$(uname -m)
    case "$ARCH" in
      x86_64) PB_ARCH="linux_amd64" ;;
      aarch64|arm64) PB_ARCH="linux_arm64" ;;
      *) echo "Unsupported arch: $ARCH"; exit 1 ;;
    esac
    curl -L "https://github.com/pocketbase/pocketbase/releases/download/v${PB_VERSION}/pocketbase_${PB_VERSION}_${PB_ARCH}.zip" -o /tmp/pb.zip
    unzip -o /tmp/pb.zip -d $APP_DIR/backend/
    rm /tmp/pb.zip
    chmod +x $APP_DIR/backend/pocketbase
    chown $APP_USER:$APP_USER $APP_DIR/backend/pocketbase

    # --- Configure Secrets ---
    SECRETS_DIR="/home/$APP_USER/.secrets"
    mkdir -p $SECRETS_DIR
    cat > $SECRETS_DIR/env << ENVEOF
    DAILY_CO_API_KEY=$DAILY_API_KEY
    FCM_API_KEY=$FCM_API_KEY
    ENVEOF
    chmod 700 $SECRETS_DIR && chmod 600 $SECRETS_DIR/*
    chown -R $APP_USER:$APP_USER $SECRETS_DIR

    echo "VITE_POCKETBASE_URL=https://$DOMAIN" > $APP_DIR/frontend/.env
    chown $APP_USER:$APP_USER $APP_DIR/frontend/.env

    # --- Build Frontend ---
    sudo -u $APP_USER bash -c "cd $APP_DIR/frontend && ~/.bun/bin/bun install && ~/.bun/bin/bun run build"

    # Fix permissions for Caddy
    chmod 711 /home/$APP_USER
    chmod 755 $APP_DIR $APP_DIR/frontend $APP_DIR/frontend/dist

    # --- Configure Caddy ---
    mkdir -p /var/log/caddy
    cat > /etc/caddy/Caddyfile << EOF
    $DOMAIN {
        encode gzip

        handle /_/* {
            reverse_proxy localhost:8090
        }

        handle /api/* {
            reverse_proxy localhost:8090
        }

        handle {
            root * $APP_DIR/frontend/dist
            try_files {path} /index.html
            file_server
        }

        header {
            X-Frame-Options "SAMEORIGIN"
            X-Content-Type-Options "nosniff"
            X-XSS-Protection "1; mode=block"
        }

        log {
            output file /var/log/caddy/nokta.log
            format json
        }
    }
    EOF
    chown -R caddy:caddy /var/log/caddy

    # --- Create Systemd Service for PocketBase ---
    cat > /etc/systemd/system/nokta-backend.service << EOF
    [Unit]
    Description=Nokta Backend
    After=network.target

    [Service]
    Type=simple
    User=$APP_USER
    WorkingDirectory=$APP_DIR/backend
    EnvironmentFile=/home/$APP_USER/.secrets/env
    ExecStart=$APP_DIR/backend/pocketbase serve --http=127.0.0.1:8090
    Restart=always
    RestartSec=5

    NoNewPrivileges=true
    PrivateTmp=true
    ProtectSystem=strict
    ProtectHome=read-only
    ReadWritePaths=$APP_DIR/backend/pb_data

    [Install]
    WantedBy=multi-user.target
    EOF

    # --- Setup Firebase (if configured) ---
    if [ -n "$FIREBASE_SA_BASE64" ]; then
      echo "$FIREBASE_SA_BASE64" | base64 -d > $SECRETS_DIR/firebase-service-account.json
      chmod 600 $SECRETS_DIR/firebase-service-account.json
      sudo -u $APP_USER bash -c "cd $APP_DIR/backend && ~/.bun/bin/bun install"
      cat > /etc/systemd/system/nokta-fcm.service << EOF
    [Unit]
    Description=Nokta FCM Push Service
    After=network.target

    [Service]
    Type=simple
    User=$APP_USER
    Environment=SECRETS_PATH=$SECRETS_DIR
    Environment=FCM_API_KEY=$FCM_API_KEY
    ExecStart=/home/$APP_USER/.bun/bin/bun run $APP_DIR/backend/fcm-service.ts
    Restart=always
    RestartSec=5

    [Install]
    WantedBy=multi-user.target
    EOF
      systemctl enable nokta-fcm
    fi

    # --- Initialize PocketBase ---
    cd $APP_DIR/backend
    sudo -u $APP_USER ./pocketbase superuser create "$ADMIN_EMAIL" "$ADMIN_PASSWORD" || true

    # --- Start Services ---
    systemctl daemon-reload
    systemctl enable nokta-backend
    systemctl start nokta-backend
    if [ -n "$FIREBASE_SA_BASE64" ]; then
      systemctl start nokta-fcm
    fi
    sleep 5
    systemctl reload caddy

    # --- Create Admin User & Enable Rate Limiting ---
    sleep 3
    TOKEN=$(curl -s -X POST http://127.0.0.1:8090/api/admins/auth-with-password \
      -H "Content-Type: application/json" \
      -d "{\"identity\":\"$ADMIN_EMAIL\",\"password\":\"$ADMIN_PASSWORD\"}" | grep -o '"token":"[^"]*' | cut -d'"' -f4)

    if [ -n "$TOKEN" ]; then
      # Create admin user
      curl -s -X POST http://127.0.0.1:8090/api/collections/users/records \
        -H "Authorization: $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"email\":\"$ADMIN_EMAIL\",\"password\":\"$ADMIN_PASSWORD\",\"passwordConfirm\":\"$ADMIN_PASSWORD\",\"name\":\"Admin\",\"role\":\"Admin\"}" || true

      # Enable rate limiting
      curl -s -X PATCH http://127.0.0.1:8090/api/settings \
        -H "Authorization: $TOKEN" \
        -H "Content-Type: application/json" \
        -d '{"rateLimits":{"enabled":true,"rules":[{"label":"/api/collections/users/auth-with-password","audience":"","duration":900,"maxRequests":5},{"label":"/api/collections/_superusers/auth-with-password","audience":"","duration":900,"maxRequests":3}]}}' || true
    fi

    # --- Log Rotation ---
    cat > /etc/logrotate.d/nokta << EOF
    $APP_DIR/backend/*.log {
        daily
        rotate 14
        compress
        missingok
        notifempty
    }
    EOF

    # --- Maintenance Scripts (scripts are in repo, just set permissions) ---
    chmod +x $APP_DIR/backup.sh $APP_DIR/update.sh

    # --- Daily Backups ---
    sudo -u $APP_USER bash -c "(crontab -l 2>/dev/null || true; echo \"0 3 * * * $APP_DIR/backup.sh >> $APP_DIR/backup.log 2>&1\") | crontab -"

    # Make install log readable
    chmod 644 /var/log/nokta-install.log

    echo "=== Nokta Installation Complete ==="
    echo "Visit: https://$DOMAIN"
